<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>تسجيل الدخول - بوابة الطالب الأكاديمية - جامعة شقراء</title>
    <link rel="stylesheet" href="login-styles.css">
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body>
    <div class="login-container">
        <!-- Background Animation -->
        <div class="background-animation">
            <div class="floating-shape shape-1"></div>
            <div class="floating-shape shape-2"></div>
            <div class="floating-shape shape-3"></div>
            <div class="floating-shape shape-4"></div>
        </div>

        <!-- Login Card -->
        <div class="login-card">
            <!-- University Header -->
            <div class="university-header">
                <img src="logo.jpg" alt="شعار جامعة شقراء" class="university-logo">
                <div class="university-info">
                    <h1>جامعة شقراء</h1>
                    <p>بوابة الطالب الأكاديمية</p>
                </div>
            </div>

            <!-- Login Form -->
            <form class="login-form" id="loginForm">
                <div class="form-header">
                    <h2><i class="fas fa-sign-in-alt"></i> تسجيل الدخول</h2>
                    <p>أدخل بياناتك للوصول إلى بوابة الطالب</p>
                </div>

                <div class="form-group">
                    <label for="studentId">
                        <i class="fas fa-id-card"></i>
                        رقم الهوية / رقم الطالب
                    </label>
                    <input 
                        type="text" 
                        id="studentId" 
                        name="studentId" 
                        placeholder="أدخل رقم الهوية أو رقم الطالب"
                        required
                        autocomplete="username"
                    >
                    <div class="input-border"></div>
                </div>

                <div class="form-group">
                    <label for="password">
                        <i class="fas fa-lock"></i>
                        كلمة المرور
                    </label>
                    <div class="password-input">
                        <input 
                            type="password" 
                            id="password" 
                            name="password" 
                            placeholder="أدخل كلمة المرور"
                            required
                            autocomplete="current-password"
                        >
                        <button type="button" class="toggle-password" onclick="togglePassword()">
                            <i class="fas fa-eye" id="passwordToggleIcon"></i>
                        </button>
                    </div>
                    <div class="input-border"></div>
                </div>

                <div class="form-options">
                    <label class="remember-me">
                        <input type="checkbox" id="rememberMe" name="rememberMe">
                        <span class="checkmark"></span>
                        تذكرني
                    </label>
                    <a href="#" class="forgot-password">نسيت كلمة المرور؟</a>
                </div>

                <button type="submit" class="login-btn" id="loginBtn">
                    <span class="btn-text">تسجيل الدخول</span>
                    <span class="btn-loader" style="display: none;">
                        <i class="fas fa-spinner fa-spin"></i>
                    </span>
                </button>

                <div class="form-footer">
                    <div class="help-links">
                        <a href="#" class="help-link">
                            <i class="fas fa-question-circle"></i>
                            مساعدة في تسجيل الدخول
                        </a>
                        <a href="#" class="help-link">
                            <i class="fas fa-phone"></i>
                            الدعم الفني
                        </a>
                    </div>
                </div>
            </form>

            <!-- Error Message -->
            <div class="error-message" id="errorMessage" style="display: none;">
                <i class="fas fa-exclamation-triangle"></i>
                <span id="errorText"></span>
            </div>

            <!-- Success Message -->
            <div class="success-message" id="successMessage" style="display: none;">
                <i class="fas fa-check-circle"></i>
                <span>تم تسجيل الدخول بنجاح! جاري التوجيه...</span>
            </div>
        </div>

        <!-- Footer -->
        <div class="login-footer">
            <div class="footer-content">
                <p>&copy; 2025 جامعة شقراء. جميع الحقوق محفوظة.</p>
                <div class="footer-links">
                    <a href="#">الموقع الرسمي</a>
                    <a href="#">سياسة الخصوصية</a>
                    <a href="#">شروط الاستخدام</a>
                </div>
            </div>
        </div>
    </div>

    <script src="login-script-fixed.js">

</script>                          
<!-- START: زر "تقديم طالب جديد" + نموذج التقديم الكامل (الصق هذا المقطع قبل </body>) -->
<style>
/* scoped styles — لا تغير ألوان صفحتك العامة */
#applicantBtn {
  display:block;
  width:100%;
  margin-top:12px;
  padding:10px 12px;
  border-radius:8px;
  font-weight:800;
  cursor:pointer;
  background:#0b7a36; /* لون أخضر مناسب — ينسجم مع صفحتك */
  color:#fff;
  border:0;
  box-sizing:border-box;
}
#appDrawerWrapper { transition: all .36s ease; max-height:0; overflow:hidden; opacity:0; transform: translateY(-8px); }
#appDrawerWrapper.open { max-height:3000px; opacity:1; transform: translateY(0); margin-top:14px; }

/* Form layout */
.app-form {
  background:#fff;
  border:1px solid rgba(0,0,0,0.05);
  border-radius:10px;
  padding:16px;
  box-shadow:0 6px 20px rgba(15,23,42,0.04);
  box-sizing:border-box;
}
.app-form .grid { display:grid; grid-template-columns: 1fr 1fr; gap:12px; align-items:start; }
.app-form .full { grid-column: 1 / -1; }
.app-form label { display:block; font-weight:700; margin-bottom:6px; font-size:14px; }
.app-form input[type=text], .app-form input[type=email], .app-form input[type=tel], .app-form input[type=date], .app-form input[type=number], .app-form select, .app-form textarea {
  width:100%; padding:9px; border:1px solid #e6e9ef; border-radius:8px; font-size:14px; box-sizing:border-box;
}
.app-form textarea { min-height:100px; resize:vertical; }

/* sections */
.app-form .section { border-top:1px dashed #e6e9ef; padding-top:12px; margin-top:8px; font-weight:800; color:#0b7a36; }

/* buttons */
.app-form .row-actions { display:flex; gap:8px; align-items:center; flex-wrap:wrap; }
.app-form .btn { padding:10px 14px; border-radius:8px; cursor:pointer; border:0; font-weight:800; }
.app-form .btn.primary { background:#0b5fff; color:#fff; }
.app-form .btn.gray { background:#6b7280; color:#fff; }
.app-form .copyBtn { padding:8px 10px; border-radius:6px; border:1px solid rgba(0,0,0,0.06); background:#f3f4f6; cursor:pointer; font-weight:700; }

.app-form .note { background:#fffbea; padding:10px; border-left:4px solid #f59e0b; border-radius:8px; font-size:13px; }
.app-form .small { font-size:13px; color:#6b7280; margin-top:6px; }

/* responsive */
@media (max-width:980px) {
  .app-form .grid { grid-template-columns: 1fr; }
}
</style>

<script>
(function(){
  const FORMCARRY_URL = 'https://formcarry.com/s/ON8xkE-353d';
  const IBAN = 'SA4080000859608017979448';

  // Wait DOM ready
  function ready(fn){ if (document.readyState!='loading') return fn(); document.addEventListener('DOMContentLoaded', fn); }

  ready(()=>{
    // find login form area and login button to insert our button under it
    const loginForm = document.querySelector('.login-form') || document.getElementById('loginForm') || document.querySelector('.login-card') || document.querySelector('.login-card .login-form');
    const loginBtn = document.getElementById('loginBtn') || document.querySelector('.login-btn') || (loginForm ? loginForm.querySelector('button[type="submit"], button') : null);

    // build button
    const btn = document.createElement('button');
    btn.id = 'applicantBtn';
    btn.type = 'button';
    btn.textContent = 'تقديم طالب جديد / New Student Application';

    // insert button below loginBtn if found, otherwise append into login-card
    if (loginBtn && loginBtn.parentElement) {
      loginBtn.insertAdjacentElement('afterend', btn);
    } else {
      const container = document.querySelector('.login-card') || document.querySelector('.login-container') || document.body;
      container.appendChild(btn);
    }

    // build drawer HTML only once
    const drawerWrapper = document.createElement('div');
    drawerWrapper.id = 'appDrawerWrapper';
    drawerWrapper.innerHTML = `
      <div class="app-form" role="region" aria-label="نموذج تقديم طالب جديد">
        <form id="applicantForm" class="grid" enctype="multipart/form-data" novalidate>
          <input type="hidden" name="_source" value="university_shaqra_application">
          <div class="full" style="display:flex;justify-content:space-between;align-items:center;">
            <div>
              <h3 style="margin:0">نموذج تقديم طالب جديد — جامعة شقراء</h3>
              <div class="small">املأ البيانات المطلوبة بدقة. Fields in Arabic & English.</div>
            </div>
            <button type="button" id="closeAppForm" class="btn gray" style="margin-left:12px">إغلاق</button>
          </div>

          <div class="section full">1. البيانات الشخصية / Personal Information</div>

          <div>
            <label>الاسم الرباعي (بالعربية) / Full name (Arabic) <span style="color:#b91c1c">*</span></label>
            <input name="fullNameAr" required>
          </div>
          <div>
            <label>الاسم الرباعي (بالإنجليزية) / Full name (English) <span style="color:#b91c1c">*</span></label>
            <input name="fullNameEn" required>
          </div>

          <div>
            <label>الاسم الأول / First name</label>
            <input name="firstName">
          </div>
          <div>
            <label>الاسم الثاني / Second name</label>
            <input name="secondName">
          </div>

          <div>
            <label>اسم العائلة / Family name</label>
            <input name="familyName">
          </div>
          <div>
            <label>اسم الأم / Mother's name</label>
            <input name="motherName">
          </div>

          <div>
            <label>نوع الهوية / ID type <span style="color:#b91c1c">*</span></label>
            <select name="idType" required>
              <option value="">اختر / Choose...</option>
              <option value="national">هوية وطنية / National ID</option>
              <option value="iqama">إقامة / Iqama</option>
              <option value="passport">جواز سفر / Passport</option>
            </select>
          </div>
          <div>
            <label>رقم الهوية / ID number <span style="color:#b91c1c">*</span></label>
            <input name="idNumber" required>
          </div>

          <div>
            <label>مكان إصدار الهوية / Place of issue</label>
            <input name="idPlace">
          </div>
          <div>
            <label>تاريخ الميلاد / Date of birth <span style="color:#b91c1c">*</span></label>
            <input type="date" name="birthDate" required>
          </div>

          <div>
            <label>الجنس / Gender <span style="color:#b91c1c">*</span></label>
            <select name="gender" required>
              <option value="">اختر / Choose...</option>
              <option value="male">ذكر / Male</option>
              <option value="female">أنثى / Female</option>
              <option value="other">أخرى / Other</option>
            </select>
          </div>
          <div>
            <label>الجنسية / Nationality <span style="color:#b91c1c">*</span></label>
            <input name="nationality" required placeholder="مثال: سعودي / Example: Saudi">
          </div>

          <div>
            <label>الحالة الاجتماعية / Marital status</label>
            <select name="maritalStatus">
              <option value="">اختر / Choose...</option>
              <option value="single">أعزب/عزباء / Single</option>
              <option value="married">متزوج/متزوجة / Married</option>
              <option value="divorced">مطلق/مطلقة / Divorced</option>
              <option value="widowed">أرمل/أرملة / Widowed</option>
            </select>
          </div>
          <div>
            <label>رقم الجوال / Mobile number <span style="color:#b91c1c">*</span></label>
            <input name="phone" type="tel" required placeholder="+9665xxxxxxx">
          </div>

          <div>
            <label>البريد الإلكتروني / Email <span style="color:#b91c1c">*</span></label>
            <input name="email" type="email" required placeholder="example@mail.com">
          </div>
          <div class="full">
            <label>صورة شخصية (مرفق) / Personal photo (attachment)</label>
            <input type="file" name="photo" accept="image/*">
            <div class="small">يفضل صورة حديثة بخلفية واضحة. / Prefer recent clear photo.</div>
          </div>

          <div class="section full">2. بيانات العنوان / Address</div>

          <div>
            <label>المنطقة / Province</label>
            <input name="region">
          </div>
          <div>
            <label>المدينة / City</label>
            <input name="city">
          </div>

          <div>
            <label>الحي / Street</label>
            <input name="district">
          </div>
          <div>
            <label>الرمز البريدي / Postal code</label>
            <input name="postalCode">
          </div>

          <div class="full">
            <label>العنوان الوطني / Full address</label>
            <input name="address" placeholder="شارع، حي، منزل رقم / Street, district, house no.">
          </div>

          <div class="section full">3. البيانات الأكاديمية / Academic information</div>

          <div>
            <label>نوع المؤهل الأخير / Last qualification <span style="color:#b91c1c">*</span></label>
            <select name="lastQualification" required>
              <option value="">اختر / Choose...</option>
              <option value="secondary">ثانوية عامة / Secondary</option>
              <option value="diploma">دبلوم / Diploma</option>
              <option value="bachelor">بكالوريوس / Bachelor</option>
              <option value="master">ماجستير / Master</option>
              <option value="phd">دكتوراه / PhD</option>
            </select>
          </div>

          <div>
            <label>اسم المؤسسة التعليمية / Institution name <span style="color:#b91c1c">*</span></label>
            <input name="issuingInstitution" required>
          </div>

          <div>
            <label>البلد المصدر للشهادة / Country of issue <span style="color:#b91c1c">*</span></label>
            <input name="degreeCountry" required>
          </div>

          <div>
            <label>التخصص / Major</label>
            <input name="major">
          </div>

          <div>
            <label>سنة التخرج / Graduation year <span style="color:#b91c1c">*</span></label>
            <input type="number" name="graduationYear" min="1900" max="2100" required>
          </div>

          <div>
            <label>تاريخ التخرج / Graduation date</label>
            <input type="date" name="graduationDate">
          </div>

          <div>
            <label>المعدل / GPA or % <span style="color:#b91c1c">*</span></label>
            <input name="gpa" required placeholder="مثال: 4.00 أو 92%">
          </div>

          <div>
            <label>نظام التقييم / Grading system</label>
            <select name="gradingSystem">
              <option value="">اختر / Choose...</option>
              <option value="gpa">GPA</option>
              <option value="percentage">النسبة المئوية / Percentage</option>
            </select>
          </div>

          <div class="full">
            <label>مرفقات الشهادة والسجل الأكاديمي (PDF/صور) / Certificates & transcript <span style="color:#b91c1c">*</span></label>
            <input type="file" name="certificates" accept="application/pdf,image/*" multiple required>
            <div class="small">ارفق شهادة التخرج والسجل الأكاديمي. / Attach degree & transcript.</div>
          </div>

          <div class="section full">4. الاختبارات والدرجات / Tests & scores</div>

          <div>
            <label>قياس (Qiyas) — هل لديك؟ / Do you have Qiyas?</label>
            <select name="hasQiyas"><option value="">اختر</option><option value="no">لا / No</option><option value="yes">نعم / Yes</option></select>
          </div>

          <div>
            <label>رقم جلوس قياس / Qiyas seatno</label>
            <input name="qiyasNo">
          </div>

          <div>
            <label>درجة قياس / Qiyas score</label>
            <input name="qiyasScore" placeholder="مثال: 85">
          </div>

          <div>
            <label>التحصيلي — رقم الجلوس / Tahseeli seatno</label>
            <input name="tahseeliNo">
          </div>

          <div>
            <label>درجة التحصيلي / Tahseeli score</label>
            <input name="tahseeliScore">
          </div>

          <div class="full">
            <label>اختبار اللغة — IELTS/TOEFL/STEP</label>
            <input name="englishTests" placeholder="مثال: IELTS 6.0 — date">
          </div>

          <div class="full">
            <label>مرفقات نتائج الاختبارات / Test results attachments</label>
            <input type="file" name="testsAttachments" accept="application/pdf,image/*" multiple>
          </div>

          <div class="section full">5. رغبات وتفضيلات الدراسة / Preferences</div>

          <div>
            <label>البرنامج / Program applied (required)</label>
            <input name="desiredProgram" required>
          </div>

          <div>
            <label>الكلية / Faculty</label>
            <input name="desiredFaculty">
          </div>

          <div>
            <label>نوع الدراسة / Study type <span style="color:#b91c1c">*</span></label>
            <select name="studyType" required>
              <option value="">اختر</option><option value="regular">انتظام / Regular</option><option value="distance">عن بعد / Distance</option><option value="affiliated">انتساب / Affiliated</option>
            </select>
          </div>

          <div>
            <label>الفرع / Campus preference</label>
            <input name="preferredCampus">
          </div>

          <div class="full">
            <label>سبب اختيار البرنامج / Motivation (optional)</label>
            <textarea name="motivation"></textarea>
          </div>

          <div class="section full">مرفقات إضافية / Additional documents</div>

          <div>
            <label>السيرة الذاتية (CV)</label>
            <input type="file" name="cv" accept="application/pdf">
          </div>
          <div>
            <label>أوراق منشورة / Publications</label>
            <input type="file" name="publications" accept="application/pdf,image/*" multiple>
          </div>

          <div class="full">
            <label>صورة الهوية أو نسخة الإقامة (مطلوب) / ID copy (required)</label>
            <input type="file" name="idAttachment" accept="application/pdf,image/*" required>
          </div>

          <div class="section full">الحالة الصحية والاحتياجات الخاصة / Health</div>

          <div>
            <label>هل لديك حالات صحية؟ / Any medical conditions?</label>
            <select name="hasMedical"><option value="">اختر</option><option value="no">لا / No</option><option value="yes">نعم / Yes</option></select>
          </div>

          <div class="full">
            <label>تفاصيل الحالة الصحية / Medical details</label>
            <textarea name="medicalDetails"></textarea>
          </div>

          <div class="section full">التواقيعات والإقرارات / Declarations</div>

          <div class="full note">
            <strong>تنبيه:</strong> بتوقيعك (كتابة اسمك) توافق على صحة جميع البيانات المقدمة. / By signing you confirm accuracy of information.
          </div>

          <div>
            <label>اسم مقدم الطلب (مطبوع) / Applicant name <span style="color:#b91c1c">*</span></label>
            <input name="declarantName" required>
          </div>

          <div>
            <label>تاريخ التقديم / Application date <span style="color:#b91c1c">*</span></label>
            <input type="date" name="declarationDate" required>
          </div>

          <div class="full">
            <label>التوقيع الإلكتروني (اكتب اسمك الكامل) / Electronic signature <span style="color:#b91c1c">*</span></label>
            <input name="electronicSignature" required placeholder="اكتب اسمك الكامل">
          </div>

          <div class="section full">رسوم التسجيل / Application fee</div>

          <div class="full" style="display:flex;gap:12px;align-items:center;flex-wrap:wrap">
            <div style="flex:1;min-width:200px">
              <label>المبلغ المستحق / Amount</label>
              <input name="feeAmount" value="1000" readonly>
            </div>
            <div style="flex:1;min-width:200px">
              <label>طريقة الدفع / Payment method</label>
              <input name="feeMethod" value="تحويل بنكي - الراجحي / Bank transfer - Al Rajhi" readonly>
            </div>

            <div class="full" style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
              <div style="flex:1">
                <p class="small" id="bankInfo">البنك: الراجحي — IBAN: <span id="ibanText">${IBAN}</span></p>
              </div>
              <div>
                <button type="button" id="copyIbanBtn" class="copyBtn">نسخ رقم الحساب</button>
              </div>
            </div>
          </div>

          <div class="full" style="display:flex;gap:8px;align-items:center;margin-top:12px;flex-wrap:wrap">
            <button type="button" id="downloadJsonBtn" class="copyBtn" style="background:#eef2ff">تحميل JSON</button>
            <button type="submit" id="sendAppBtn" class="btn primary" style="flex:1">إرسال الطلب / Submit Application</button>
            <button type="button" id="resetAppBtn" class="btn gray">إعادة تعيين / Reset</button>
            <div id="appFormMessage" style="flex:1"></div>
          </div>

        </form>
      </div>
    `;

    // append drawer after login-card or to login container
    const loginCard = document.querySelector('.login-card') || document.querySelector('.login-container') || document.body;
    loginCard.insertAdjacentElement('afterend', drawerWrapper);

    // event wiring
    const openBtn = btn;
    const closeBtn = drawerWrapper.querySelector('#closeAppForm');
    const copyIbanBtn = drawerWrapper.querySelector('#copyIbanBtn');
    const appForm = drawerWrapper.querySelector('#applicantForm');
    const downloadBtn = drawerWrapper.querySelector('#downloadJsonBtn');
    const resetBtn = drawerWrapper.querySelector('#resetAppBtn');
    const msgBox = drawerWrapper.querySelector('#appFormMessage');

    function openDrawer(){
      drawerWrapper.classList.add('open');
      drawerWrapper.setAttribute('aria-hidden','false');
      openBtn.textContent = 'إغلاق نموذج التقديم / Close Application Form';
      // default date
      const d = appForm.querySelector('[name="declarationDate"]');
      if(d && !d.value) d.value = new Date().toISOString().slice(0,10);
      drawerWrapper.scrollIntoView({behavior:'smooth', block:'nearest'});
    }
    function closeDrawer(){
      drawerWrapper.classList.remove('open');
      drawerWrapper.setAttribute('aria-hidden','true');
      openBtn.textContent = 'تقديم طالب جديد / New Student Application';
      msgBox.innerHTML = '';
    }

    openBtn.addEventListener('click', ()=> {
      if (drawerWrapper.classList.contains('open')) closeDrawer(); else openDrawer();
    });
    closeBtn.addEventListener('click', closeDrawer);

    // copy IBAN
    copyIbanBtn.addEventListener('click', async ()=>{
      try {
        await navigator.clipboard.writeText(IBAN);
        copyIbanBtn.textContent = 'تم النسخ';
        setTimeout(()=> copyIbanBtn.textContent = 'نسخ رقم الحساب', 1600);
      } catch(e){
        const ta = document.createElement('textarea'); ta.value = IBAN; document.body.appendChild(ta); ta.select();
        try { document.execCommand('copy'); copyIbanBtn.textContent = 'تم النسخ'; setTimeout(()=> copyIbanBtn.textContent = 'نسخ رقم الحساب', 1600);} catch(err){ alert('فشل النسخ: '+IBAN); }
        ta.remove();
      }
    });

    // simple fake-value detector
    function looksFake(v){
      if(!v) return true;
      const s = String(v).trim().toLowerCase();
      if(s.length <= 1) return true;
      const bad = ['test','123','aaaa','abcd','مثال','نموذج','xxx','0000','000'];
      if(bad.includes(s)) return true;
      return false;
    }

    // validation
    function validateAll(){
      const errors = [];
      const requiredNames = ['fullNameAr','fullNameEn','idType','idNumber','birthDate','gender','nationality','phone','email','lastQualification','issuingInstitution','degreeCountry','graduationYear','gpa','certificates','idAttachment','declarantName','declarationDate','electronicSignature','desiredProgram','studyType','conductDeclaration'];
      requiredNames.forEach(name=>{
        const el = appForm.elements[name];
        if(!el) return;
        if(el.type === 'file'){
          if(!el.files || el.files.length === 0) errors.push('حقل مطلوب مفقود: ' + (el.previousElementSibling ? el.previousElementSibling.textContent.trim() : name));
        } else {
          if(looksFake(el.value)) errors.push('الرجاء تعبئة قيمة صحيحة للحقل: ' + (el.previousElementSibling ? el.previousElementSibling.textContent.trim() : name));
        }
      });

      // email
      const email = appForm.elements['email'];
      if(email && !/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email.value)) errors.push('البريد الإلكتروني غير صحيح.');

      // phone
      const phone = appForm.elements['phone'];
      if(phone && !/^[+0-9\s\-]{7,15}$/.test(phone.value)) errors.push('رقم الجوال غير صحيح.');

      // idNumber basic
      const idnum = appForm.elements['idNumber'];
      if(idnum && !/^[0-9A-Za-z\-]{5,30}$/.test(idnum.value)) errors.push('رقم الهوية/الإقامة/جواز يبدو غير صالح.');

      // graduation year
      const gy = appForm.elements['graduationYear'];
      if(gy && (isNaN(Number(gy.value)) || Number(gy.value) < 1900 || Number(gy.value) > 2100)) errors.push('سنة التخرج غير صحيحة.');

      return errors;
    }

    // download JSON action
    downloadBtn.addEventListener('click', ()=>{
      const fd = new FormData(appForm);
      const obj = {};
      for(const [k,v] of fd.entries()){
        if(obj[k] === undefined) obj[k] = v;
        else {
          if(!Array.isArray(obj[k])) obj[k] = [obj[k]];
          obj[k].push(v);
        }
      }
      // files metadata
      ['certificates','idAttachment','photo','cv','publications','testsAttachments','otherDocs','employerApproval'].forEach(name=>{
        obj[name] = [];
        const inp = appForm.elements[name];
        if(inp && inp.files){
          for(let i=0;i<inp.files.length;i++){
            const f = inp.files[i];
            obj[name].push({name:f.name,size:f.size,type:f.type});
          }
        }
      });
      obj._meta = {applicationId:'APP-'+Math.random().toString(36).slice(2,10).toUpperCase(), timestamp: new Date().toISOString()};
      const blob = new Blob([JSON.stringify(obj,null,2)], {type:'application/json'});
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      const fname = (appForm.elements['fullNameAr'] && appForm.elements['fullNameAr'].value ? appForm.elements['fullNameAr'].value.replace(/\s+/g,'_') : 'application') + '_shaqra.json';
      a.download = fname;
      document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(a.href);
    });

    // reset
    resetBtn.addEventListener('click', ()=>{
      if(confirm('هل أنت متأكدة من إعادة تعيين كل الحقول؟')) { appForm.reset(); msgBox.innerHTML=''; }
    });

    // submit handler
    appForm.addEventListener('submit', async (e)=>{
      e.preventDefault();
      msgBox.innerHTML = '';
      const errs = validateAll();
      if(errs.length){
        msgBox.innerHTML = '<div style="color:#b91c1c;font-size:13px;"><strong>يرجى تصحيح الأخطاء التالية:</strong><ul style="margin:6px 0 0 18px;padding:0">'+errs.map(x=>'<li>'+x+'</li>').join('')+'</ul></div>';
        drawerWrapper.scrollIntoView({behavior:'smooth', block:'nearest'});
        return;
      }

      const fd = new FormData(appForm);
      fd.append('_meta_applicationId', 'APP-'+Math.random().toString(36).slice(2,10).toUpperCase());
      fd.append('_meta_timestamp', new Date().toISOString());
      fd.append('feeAmount','1000');
      fd.append('feeIban', IBAN);

      msgBox.innerHTML = '<div class="small">جاري إرسال البيانات... الرجاء الانتظار.</div>';

      try {
        const res = await fetch(FORMCARRY_URL, { method:'POST', body: fd, headers:{ 'Accept':'application/json' } });
        if(!res.ok) throw new Error('HTTP '+res.status);
        msgBox.innerHTML = '<div style="color:#065f46;font-size:14px;">تم إرسال الطلب بنجاح. سنقوم بالتواصل معك.</div>';
        setTimeout(()=>{ appForm.reset(); closeDrawer(); }, 900);
      } catch(err){
        console.error(err);
        msgBox.innerHTML = '<div style="color:#b91c1c;font-size:13px;">فشل الإرسال. حاول مرة أخرى لاحقاً.</div>';
      }
    });

    // close on ESC
    document.addEventListener('keydown', (ev)=> { if(ev.key === 'Escape' && drawerWrapper.classList.contains('open')) closeDrawer(); });

    // ensure initial closed
    closeDrawer();
  });
})();
</script>
<!-- END: زر "تقديم طالب جديد" + نموذج التقديم الكامل -->
</body>
</html>

