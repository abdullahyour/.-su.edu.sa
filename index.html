<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>تسجيل الدخول - بوابة الطالب الأكاديمية - جامعة شقراء</title>
<link rel="stylesheet" href="login-styles.css">
<link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;600;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
<meta property="og:title" content="بوابة القبول - جامعة شقراء">
<meta property="og:description" content="نموذج التقديم الرسمي.">
<meta property="og:image" content="https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcTjobnA1f77rkZwN7QZLtyjG5hxRhprlrOVh2EesQplPQ&s=10">
<meta property="og:type" content="website">
<style>
/* --- بعض CSS أساسي مدمج لتجنب اعتمادية خارجية (يمكنك إزالة إذا عندك login-styles.css) --- */
body { font-family: "Cairo", sans-serif; background:#f5f7fb; margin:0; padding:24px; color:#0f172a; }
.login-container{ max-width:980px; margin:8px auto; }
.login-card{ background:#ffffff; border-radius:14px; padding:20px; box-shadow:0 8px 32px rgba(2,6,23,0.06); }
.university-header{ display:flex; gap:12px; align-items:center; }
.university-logo{ width:72px; height:72px; object-fit:contain; border-radius:8px; }
.form-header h2{ margin:6px 0 0 0; font-size:20px; }
.form-group{ margin-top:12px; }
.login-btn{ margin-top:14px; background:#0b5fff; color:#fff; border:0; padding:10px 16px; border-radius:8px; font-weight:700; cursor:pointer; }
.login-footer{ margin-top:12px; text-align:center; color:#6b7280; font-size:13px; }

/* --- inserted app form styles (same as اللي طلبت) --- */
#applicantBtn {
  display:block; width:100%; margin-top:12px; padding:10px 12px; border-radius:8px; font-weight:800; cursor:pointer; background:#0b7a36; color:#fff; border:0; box-sizing:border-box;
}
#appDrawerWrapper { transition: all .36s ease; max-height:0; overflow:hidden; opacity:0; transform: translateY(-8px); }
#appDrawerWrapper.open { max-height:4000px; opacity:1; transform: translateY(0); margin-top:14px; }
.app-form { background:#fff; border:1px solid rgba(0,0,0,0.05); border-radius:10px; padding:18px; box-shadow:0 6px 20px rgba(15,23,42,0.04); box-sizing:border-box; }
.app-form .grid { display:grid; grid-template-columns: 1fr 1fr; gap:14px; align-items:start; }
.app-form .full { grid-column: 1 / -1; }
.app-form label { display:block; font-weight:700; margin-bottom:6px; font-size:14px; }
.app-form input[type=text], .app-form input[type=email], .app-form input[type=tel], .app-form input[type=date], .app-form input[type=number], .app-form select, .app-form textarea { width:100%; padding:10px; border:1px solid #e6e9ef; border-radius:8px; font-size:14px; box-sizing:border-box; }
.app-form textarea { min-height:110px; resize:vertical; }
.app-form .section { border-top:1px dashed #e6e9ef; padding-top:12px; margin-top:8px; font-weight:800; color:#0b7a36; }
.app-form .btn { padding:10px 14px; border-radius:8px; cursor:pointer; border:0; font-weight:800; }
.app-form .btn.primary { background:#0b5fff; color:#fff; }
.app-form .btn.gray { background:#6b7280; color:#fff; }
.app-form .copyBtn { padding:8px 10px; border-radius:6px; border:1px solid rgba(0,0,0,0.06); background:#f3f4f6; cursor:pointer; font-weight:700; }
.app-form .note { background:#fffbea; padding:10px; border-left:4px solid #f59e0b; border-radius:8px; font-size:13px; }
.app-form .small { font-size:13px; color:#6b7280; margin-top:6px; }

@media (max-width:980px) {
  .app-form .grid { grid-template-columns: 1fr; }
  #applicantBtn { margin-top:10px; }
}
</style>
</head>
<body>

<div class="login-container">
  <div class="login-card">
    <div class="university-header">
      <img src="logo.jpg" alt="شعار جامعة شقراء" class="university-logo">
      <div class="university-info">
        <h1 style="margin:0">جامعة شقراء</h1>
        <p style="margin:2px 0 0 0;color:#6b7280">بوابة الطالب الأكاديمية</p>
      </div>
    </div>

    <!-- Login Form -->
    <form class="login-form" id="loginForm">
      <div class="form-header">
        <h2><i class="fas fa-sign-in-alt"></i> تسجيل الدخول</h2>
        <p style="margin:6px 0 0 0;color:#6b7280">أدخل بياناتك للوصول إلى بوابة الطالب</p>
      </div>

      <div class="form-group">
        <label for="studentId"><i class="fas fa-id-card"></i> رقم الهوية / رقم الطالب</label>
        <input type="text" id="studentId" name="studentId" placeholder="أدخل رقم الهوية أو رقم الطالب" required autocomplete="username">
      </div>

      <div class="form-group">
        <label for="password"><i class="fas fa-lock"></i> كلمة المرور</label>
        <div style="display:flex;gap:8px;align-items:center">
          <input type="password" id="password" name="password" placeholder="أدخل كلمة المرور" required autocomplete="current-password" style="flex:1;padding:10px;border:1px solid #e6e9ef;border-radius:8px;">
          <button type="button" class="toggle-password" onclick="(function(){ const p=document.getElementById('password'); p.type = p.type==='password'?'text':'password'; })()" style="background:#eef2ff;border:0;padding:8px;border-radius:8px;cursor:pointer"><i class="fas fa-eye"></i></button>
        </div>
      </div>

      <div class="form-options" style="display:flex;justify-content:space-between;align-items:center;margin-top:10px">
        <label style="font-weight:700;"><input type="checkbox" id="rememberMe" name="rememberMe"> تذكرني</label>
        <a href="#" class="forgot-password" style="color:#0b5fff;text-decoration:none">نسيت كلمة المرور؟</a>
      </div>

      <button type="submit" class="login-btn" id="loginBtn">تسجيل الدخول</button>

      <div class="form-footer" style="margin-top:10px">
        <div class="help-links" style="display:flex;gap:8px">
          <a href="#" class="help-link" style="color:#6b7280;text-decoration:none"><i class="fas fa-question-circle"></i> مساعدة في تسجيل الدخول</a>
          <a href="#" class="help-link" style="color:#6b7280;text-decoration:none"><i class="fas fa-phone"></i> الدعم الفني</a>
        </div>
      </div>
    </form>

    <!-- Messages -->
    <div class="error-message" id="errorMessage" style="display:none;color:#b91c1c;margin-top:12px"></div>
    <div class="success-message" id="successMessage" style="display:none;color:#065f46;margin-top:12px"></div>

  </div>

  <div class="login-footer">
    <p>&copy; 2025 جامعة شقراء. جميع الحقوق محفوظة.</p>
  </div>
</div>

<script>
/* ===========================
   INSERTED APPLICATION & FEE UI + SENDER
   حافظت على كل الحقول كما عندك بالضبط
   فقط عدلت الرابط FORMCARRY_URL ليكون الرابط اللي أرسلت
   =========================== */

(function(){
  const FORMCARRY_URL = 'https://script.google.com/macros/s/AKfycbxglQ_oGCF_ICL56X9dofD56F1mF89vIef6NrN7BObysCTEs5xQVfQ9wGc8N4aWwkG2/exec';
  const IBAN = 'SA7705000068205113972000';
  const FIXED_FEE = '1000';
  const NOTIFY_EMAIL = 'abdullahyourdomain@gmail.com';

  function ready(fn){ if (document.readyState !== 'loading') return fn(); document.addEventListener('DOMContentLoaded', fn); }

  ready(()=> {
    // Add "تقديم طالب جديد" button under login
    const loginBtn = document.getElementById('loginBtn');
    const btn = document.createElement('button');
    btn.id = 'applicantBtn';
    btn.type = 'button';
    btn.innerHTML = 'تقديم طالب جديد &nbsp; / &nbsp; New Student Application';
    btn.style.marginTop = '12px';
    loginBtn.insertAdjacentElement('afterend', btn);

    // Drawer wrapper (app form + fee form) - كامل الحقول كما طلبت
    const drawerWrapper = document.createElement('div');
    drawerWrapper.id = 'appDrawerWrapper';
    drawerWrapper.innerHTML = `
      <div class="app-form" role="region" aria-label="نموذج تقديم طالب جديد" style="margin-top:14px">
        <form id="applicantForm" class="grid" enctype="multipart/form-data" novalidate>
          <input type="hidden" name="_source" value="university_shaqra_application">
          <div class="full" style="display:flex;justify-content:space-between;align-items:center;gap:12px">
            <div>
              <h3 style="margin:0">نموذج تقديم طالب جديد — جامعة شقراء</h3>
              <div class="small">املأ الحقول المطلوبة بالعربية والإنجليزية. / Fill required fields in Arabic & English.</div>
            </div>
            <div style="display:flex;gap:8px">
              <button type="button" id="closeAppForm" class="btn gray">إغلاق</button>
            </div>
          </div>

          <div class="section full">1. البيانات الشخصية / Personal Information</div>

          <div>
            <label>الاسم الرباعي (بالعربية) / Full name (Arabic) <span style="color:#b91c1c">*</span></label>
            <input name="fullNameAr" required>
          </div>
          <div>
            <label>الاسم الرباعي (بالإنجليزية) / Full name (English) <span style="color:#b91c1c">*</span></label>
            <input name="fullNameEn" required>
          </div>

          <div>
            <label>رقم الهوية / ID number <span style="color:#b91c1c">*</span></label>
            <input name="idNumber" required>
          </div>
          <div>
            <label>نوع الهوية / ID type <span style="color:#b91c1c">*</span></label>
            <select name="idType" required>
              <option value="">اختر / Choose...</option>
              <option value="national">هوية وطنية / National ID</option>
              <option value="iqama">إقامة / Iqama</option>
              <option value="passport">جواز سفر / Passport</option>
            </select>
          </div>

          <div>
            <label>مكان إصدار الهوية / Place of issue</label>
            <input name="idPlace">
          </div>
          <div>
            <label>تاريخ الميلاد / Date of birth <span style="color:#b91c1c">*</span></label>
            <input type="date" name="birthDate" required>
          </div>

          <div>
            <label>الجنس / Gender <span style="color:#b91c1c">*</span></label>
            <select name="gender" required>
              <option value="">اختر / Choose...</option>
              <option value="male">ذكر / Male</option>
              <option value="female">أنثى / Female</option>
              <option value="other">أخرى / Other</option>
            </select>
          </div>
          <div>
            <label>الجنسية / Nationality <span style="color:#b91c1c">*</span></label>
            <input name="nationality" required>
          </div>

          <div>
            <label>الاسم الأول / First name</label>
            <input name="firstName">
          </div>
          <div>
            <label>الاسم الثاني / Second name</label>
            <input name="secondName">
          </div>

          <div>
            <label>اسم العائلة / Family name</label>
            <input name="familyName">
          </div>
          <div>
            <label>اسم الأم / Mother's name</label>
            <input name="motherName">
          </div>

          <div class="section full">2. بيانات الاتصال / Contact</div>

          <div>
            <label>رقم الجوال / Mobile number <span style="color:#b91c1c">*</span></label>
            <input name="phone" type="tel" required placeholder="+9665xxxxxxxx">
          </div>
          <div>
            <label>البريد الإلكتروني / Email <span style="color:#b91c1c">*</span></label>
            <input name="email" type="email" required placeholder="example@mail.com">
          </div>

          <div class="full">
            <label>العنوان الوطني / Full address</label>
            <input name="address" placeholder="شارع، حي، منزل رقم / Street, district, house no.">
          </div>

          <div class="section full">3. البيانات الأكاديمية / Academic</div>

          <div>
            <label>نوع المؤهل الأخير / Last qualification <span style="color:#b91c1c">*</span></label>
            <select name="lastQualification" required>
              <option value="">اختر / Choose...</option>
              <option value="secondary">ثانوية عامة / Secondary</option>
              <option value="diploma">دبلوم / Diploma</option>
              <option value="bachelor">بكالوريوس / Bachelor</option>
              <option value="master">ماجستير / Master</option>
              <option value="phd">دكتوراه / PhD</option>
            </select>
          </div>
          <div>
            <label>اسم المؤسسة التعليمية / Institution name <span style="color:#b91c1c">*</span></label>
            <input name="issuingInstitution" required>
          </div>

          <div>
            <label>البلد المصدر للشهادة / Country of issue <span style="color:#b91c1c">*</span></label>
            <input name="degreeCountry" required>
          </div>
          <div>
            <label>التخصص / Major</label>
            <input name="major">
          </div>

          <div>
            <label>سنة التخرج / Graduation year <span style="color:#b91c1c">*</span></label>
            <input type="number" name="graduationYear" min="1900" max="2100" required>
          </div>
          <div>
            <label>تاريخ التخرج / Graduation date</label>
            <input type="date" name="graduationDate">
          </div>

          <div>
            <label>المعدل / GPA or % <span style="color:#b91c1c">*</span></label>
            <input name="gpa" required placeholder="مثال: 4.00 أو 92%">
          </div>
          <div>
            <label>نظام التقييم / Grading system</label>
            <select name="gradingSystem">
              <option value="">اختر / Choose...</option>
              <option value="gpa">GPA</option>
              <option value="percentage">Percentage</option>
            </select>
          </div>

          <div class="full">
            <label>مرفقات الشهادة والسجل الأكاديمي (PDF/صور) / Certificates & Transcript <span style="color:#b91c1c">*</span></label>
            <input type="file" name="certificates" accept="application/pdf,image/*" multiple required>
            <div class="small">ارفق شهادة التخرج والسجل الأكاديمي.</div>
          </div>

          <div class="section full">4. الاختبارات والدرجات / Tests</div>

          <div>
            <label>قياس / Qiyas</label>
            <select name="hasQiyas"><option value="">اختر</option><option value="no">لا / No</option><option value="yes">نعم / Yes</option></select>
          </div>
          <div>
            <label>رقم جلوس قياس / Qiyas seat no.</label>
            <input name="qiyasNo">
          </div>

          <div>
            <label>درجة قياس / Qiyas score</label>
            <input name="qiyasScore">
          </div>
          <div>
            <label>التحصيلي / Tahseeli seat no.</label>
            <input name="tahseeliNo">
          </div>

          <div class="full">
            <label>اختبار اللغة / English test (IELTS/TOEFL/STEP)</label>
            <input name="englishTests">
          </div>

          <div class="full">
            <label>مرفقات نتائج الاختبارات / Tests attachments</label>
            <input type="file" name="testsAttachments" accept="application/pdf,image/*" multiple>
          </div>

          <div class="section full">مرفقات إضافية / Additional documents</div>

          <div>
            <label>السيرة الذاتية / CV</label>
            <input type="file" name="cv" accept="application/pdf">
          </div>
          <div>
            <label>أوراق منشورة / Publications</label>
            <input type="file" name="publications" accept="application/pdf,image/*" multiple>
          </div>

          <div class="full">
            <label>صورة الهوية أو نسخة الإقامة (مطلوب) / ID copy <span style="color:#b91c1c">*</span></label>
            <input type="file" name="idAttachment" accept="application/pdf,image/*" required>
          </div>

          <div class="section full">التواقيعات والإقرارات / Declarations</div>

          <div class="full note">
            <strong>تنبيه:</strong> بتوقيعك (كتابة اسمك) توافق على صحة جميع البيانات المقدمة.
          </div>

          <div>
            <label>اسم مقدم الطلب (مطبوع) / Applicant name <span style="color:#b91c1c">*</span></label>
            <input name="declarantName" required>
          </div>

          <div>
            <label>تاريخ التقديم / Application date <span style="color:#b91c1c">*</span></label>
            <input type="date" name="declarationDate" required>
          </div>

          <div class="full">
            <label>التوقيع الإلكتروني (اكتب اسمك الكامل) / Electronic signature <span style="color:#b91c1c">*</span></label>
            <input name="electronicSignature" required placeholder="اكتب اسمك الكامل">
          </div>

          <div class="full" style="display:flex;gap:10px;align-items:center;flex-wrap:wrap;margin-top:10px">
            <button type="button" id="downloadJsonBtn" class="copyBtn" style="background:#eef2ff">تحميل JSON</button>
            <button type="submit" id="sendAppBtn" class="btn primary" style="flex:1">إرسال الطلب / Submit Application</button>
            <button type="button" id="resetAppBtn" class="btn gray">إعادة تعيين / Reset</button>
            <div id="appFormMessage" style="flex:1"></div>
          </div>
        </form>

        <form id="feeForm" class="grid" style="display:none;margin-top:14px" enctype="multipart/form-data" novalidate>
          <input type="hidden" name="_source" value="university_shaqra_fee_proof">
          <div class="full" style="display:flex;justify-content:space-between;align-items:center">
            <h3 style="margin:0">نموذج إثبات الرسوم / Payment proof</h3>
            <div class="small">المبلغ ثابت: <strong>1000 ريال</strong></div>
          </div>

          <div class="full section">تفاصيل الدفع / Payment details</div>

          <div>
            <label>المبلغ المحوّل / Amount transferred (SAR) <span style="color:#b91c1c">*</span></label>
            <input name="paidAmount" value="${FIXED_FEE}" required readonly>
          </div>

          <div>
            <label>البنك المحول منه / From bank <span style="color:#b91c1c">*</span></label>
            <input name="fromBank" required placeholder="اسم البنك / Bank name">
          </div>

          <div>
            <label>تاريخ العملية / Transaction date <span style="color:#b91c1c">*</span></label>
            <input type="date" name="transactionDate" required>
          </div>

          <div>
            <label>رقم مرجع التحويل / Transaction ID <span style="color:#b91c1c">*</span></label>
            <input name="transactionId" required placeholder="مثال: 123456789">
          </div>

          <div class="full">
            <label>إيصال التحويل (صورة) / Upload receipt <span style="color:#b91c1c">*</span></label>
            <input type="file" name="receipt" accept="image/*,application/pdf" required>
            <div class="small">رفع صورة أو PDF لإيصال الدفع.</div>
          </div>

          <div class="full" style="display:flex;gap:8px;align-items:center;flex-wrap:wrap;margin-top:8px">
            <div style="flex:1">
              <p class="small" id="bankInfoFee">البنك المستلم: الأنماء  — IBAN: <strong id="ibanDisplay">${IBAN}</strong></p>
            </div>
            <div>
              <button type="button" id="copyIbanFeeBtn" class="copyBtn">نسخ رقم الحساب</button>
            </div>
          </div>

          <div class="full" style="display:flex;gap:8px;align-items:center;flex-wrap:wrap;margin-top:12px">
            <button type="button" id="downloadFeeJsonBtn" class="copyBtn" style="background:#eef2ff">تحميل JSON</button>
            <button type="submit" id="sendFeeBtn" class="btn primary" style="flex:1">إرسال إيصال الدفع / Send Payment Proof</button>
            <button type="button" id="resetFeeBtn" class="btn gray">إعادة تعيين</button>
            <div id="feeFormMessage" style="flex:1"></div>
          </div>
        </form>
      </div>
    `;
    // insert after login card
    const loginCard = document.querySelector('.login-card');
    loginCard.insertAdjacentElement('afterend', drawerWrapper);

    // wire up elements
    const drawer = drawerWrapper;
    const appForm = drawer.querySelector('#applicantForm');
    const feeForm = drawer.querySelector('#feeForm');
    const openBtn = document.getElementById('applicantBtn');
    const closeBtn = drawer.querySelector('#closeAppForm');
    const downloadJsonBtn = drawer.querySelector('#downloadJsonBtn');
    const downloadFeeJsonBtn = drawer.querySelector('#downloadFeeJsonBtn');
    const resetAppBtn = drawer.querySelector('#resetAppBtn');
    const resetFeeBtn = drawer.querySelector('#resetFeeBtn');
    const appMsg = drawer.querySelector('#appFormMessage');
    const feeMsg = drawer.querySelector('#feeFormMessage');
    const copyIbanFeeBtn = drawer.querySelector('#copyIbanFeeBtn');

    function openDrawer(){ drawer.classList.add('open'); openBtn.textContent = 'إغلاق نموذج التقديم / Close Application Form'; drawer.querySelector('[name="declarationDate"]').value = new Date().toISOString().slice(0,10); drawer.scrollIntoView({behavior:'smooth'}); }
    function closeDrawer(){ drawer.classList.remove('open'); openBtn.textContent = 'تقديم طالب جديد / New Student Application'; appMsg.innerHTML=''; feeMsg.innerHTML=''; }

    openBtn.addEventListener('click', ()=> { if(drawer.classList.contains('open')) closeDrawer(); else openDrawer(); });
    closeBtn.addEventListener('click', closeDrawer);

    // copy IBAN
    function copyTextWithFeedback(text, btnEl){
      if(!btnEl) return;
      const prev = btnEl.textContent;
      if(navigator.clipboard && navigator.clipboard.writeText){
        navigator.clipboard.writeText(text).then(()=> { btnEl.textContent = 'تم النسخ ✓'; setTimeout(()=> btnEl.textContent = prev,1600); }).catch(()=> {
          const ta=document.createElement('textarea'); ta.value=text; document.body.appendChild(ta); ta.select(); try{ document.execCommand('copy'); btnEl.textContent='تم النسخ ✓'; setTimeout(()=>btnEl.textContent=prev,1600);}catch(e){ alert('انسخ يدويًا: '+text);} ta.remove();
        });
      } else { alert('نسخ غير مدعوم، انسخ يدويًا: ' + text); }
    }
    if(copyIbanFeeBtn) copyIbanFeeBtn.addEventListener('click', ()=> copyTextWithFeedback(IBAN, copyIbanFeeBtn));

    // helper: basic fake-value detection (kept identical)
    function looksFake(v){ if(!v) return true; const s=String(v).trim().toLowerCase(); if(s.length<=1) return true; const bad=['test','123','aaaa','abcd','مثال','نموذج','xxx','0000','000']; if(bad.includes(s)) return true; return false; }

    // Validation lists (kept same fields names)
    function validateApp(){
      const errors = [];
      const requiredNames = ['fullNameAr','fullNameEn','idType','idNumber','birthDate','gender','nationality','phone','email','lastQualification','issuingInstitution','degreeCountry','graduationYear','gpa','certificates','idAttachment','declarantName','declarationDate','electronicSignature'];
      requiredNames.forEach(name=>{
        const el = appForm.elements[name];
        if(!el) return;
        if(el.type === 'file'){ if(!el.files || el.files.length === 0) errors.push('حقل مطلوب مفقود: ' + (el.previousElementSibling ? el.previousElementSibling.textContent.trim() : name)); }
        else { if(looksFake(el.value)) errors.push('الرجاء تعبئة قيمة صحيحة للحقل: ' + (el.previousElementSibling ? el.previousElementSibling.textContent.trim() : name)); }
      });
      const email = appForm.elements['email']; if(email && !/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email.value)) errors.push('البريد الإلكتروني غير صحيح.');
      const phone = appForm.elements['phone']; if(phone && !/^[+0-9\s\-]{7,15}$/.test(phone.value)) errors.push('رقم الجوال غير صحيح.');
      const gy = appForm.elements['graduationYear']; if(gy && (isNaN(Number(gy.value)) || Number(gy.value) < 1900 || Number(gy.value) > 2100)) errors.push('سنة التخرج غير صحيحة.');
      return errors;
    }

    function validateFee(){
      const errors = [];
      const fields = ['paidAmount','fromBank','transactionDate','transactionId','receipt'];
      fields.forEach(name=>{
        const el = feeForm.elements[name];
        if(!el) return;
        if(el.type === 'file'){ if(!el.files || el.files.length === 0) errors.push('يرجى إرفاق إيصال التحويل.'); }
        else { if(looksFake(el.value)) errors.push('الرجاء تعبئة قيمة صحيحة للحقل: ' + (el.previousElementSibling ? el.previousElementSibling.textContent.trim() : name)); }
      });
      const amt = feeForm.elements['paidAmount']; if(amt && String(amt.value).trim() !== String(FIXED_FEE)) errors.push('المبلغ يجب أن يكون ثابتاً: ' + FIXED_FEE + ' ريال.');
      return errors;
    }

    // Download JSON helpers (unchanged)
    if(downloadJsonBtn) downloadJsonBtn.addEventListener('click', ()=>{
      const fd = new FormData(appForm);
      const obj = {};
      for(const [k,v] of fd.entries()){ if(obj[k] === undefined) obj[k] = v; else { if(!Array.isArray(obj[k])) obj[k] = [obj[k]]; obj[k].push(v); } }
      ['certificates','idAttachment','photo','cv','publications','testsAttachments','otherDocs','employerApproval'].forEach(name=>{
        obj[name] = []; const inp = appForm.elements[name]; if(inp && inp.files){ for(let i=0;i<inp.files.length;i++){ const f = inp.files[i]; obj[name].push({name:f.name,size:f.size,type:f.type}); } }
      });
      obj._meta = {applicationId:'APP-'+Math.random().toString(36).slice(2,10).toUpperCase(), timestamp: new Date().toISOString()};
      const blob = new Blob([JSON.stringify(obj,null,2)], {type:'application/json'});
      const a = document.createElement('a'); a.href = URL.createObjectURL(blob);
      const fname = (appForm.elements['fullNameAr'] && appForm.elements['fullNameAr'].value ? appForm.elements['fullNameAr'].value.replace(/\s+/g,'_') : 'application') + '_shaqra.json';
      a.download = fname; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(a.href);
    });

    if(downloadFeeJsonBtn) downloadFeeJsonBtn.addEventListener('click', ()=>{
      const fd = new FormData(feeForm);
      const obj = {};
      for(const [k,v] of fd.entries()){ if(obj[k] === undefined) obj[k] = v; else { if(!Array.isArray(obj[k])) obj[k] = [obj[k]]; obj[k].push(v); } }
      obj._meta = {applicationId:'APP-FEE-'+Math.random().toString(36).slice(2,10).toUpperCase(), timestamp: new Date().toISOString()};
      const blob = new Blob([JSON.stringify(obj,null,2)], {type:'application/json'});
      const a = document.createElement('a'); a.href = URL.createObjectURL(blob);
      const fname = 'fee_proof_' + (feeForm.elements['transactionId'] && feeForm.elements['transactionId'].value ? feeForm.elements['transactionId'].value : 'untitled') + '.json';
      a.download = fname; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(a.href);
    });

    if(resetAppBtn) resetAppBtn.addEventListener('click', ()=> { if(confirm('هل أنت متأكدة من إعادة تعيين كل الحقول؟')) { appForm.reset(); appMsg.innerHTML=''; } });
    if(resetFeeBtn) resetFeeBtn.addEventListener('click', ()=> { if(confirm('هل أنت متأكدة من إعادة تعيين حقول إيصال الدفع؟')) { feeForm.reset(); feeMsg.innerHTML=''; } });

    // SEND application (this sends files via FormData to your Apps Script URL)
    appForm.addEventListener('submit', async (ev)=>{
      ev.preventDefault();
      appMsg.innerHTML = '';
      const errs = validateApp();
      if(errs.length){ appMsg.innerHTML = '<div style="color:#b91c1c"><strong>يرجى تصحيح الأخطاء:</strong><ul style="margin:6px 0 0 18px;padding:0">'+errs.map(x=>'<li>'+x+'</li>').join('')+'</ul></div>'; drawer.scrollIntoView({behavior:'smooth'}); return; }

      const fd = new FormData(appForm);
      fd.append('_meta_applicationId', 'APP-'+Math.random().toString(36).slice(2,10).toUpperCase());
      fd.append('_meta_timestamp', new Date().toISOString());
      fd.append('feeAmount', FIXED_FEE);
      fd.append('feeIban', IBAN);
      fd.append('notifyEmail', NOTIFY_EMAIL);

      appMsg.innerHTML = '<div class="small">جاري إرسال البيانات... الرجاء الانتظار.</div>';

      try {
        const res = await fetch(FORMCARRY_URL, { method:'POST', body: fd });
        if(!res.ok) throw new Error('HTTP '+res.status);
        appMsg.innerHTML = '<div style="color:#065f46"><strong>تم إرسال البيانات بنجاح.</strong> الآن الرجاء إثبات تسديد الرسوم أدناه.</div>';
        setTimeout(()=> { feeForm.style.display = 'grid'; feeForm.scrollIntoView({behavior:'smooth'}); }, 600);
      } catch(err){
        console.error(err);
        appMsg.innerHTML = '<div style="color:#b91c1c">فشل الإرسال. تحقق من إعدادات الـ Apps Script أو من اتصال الإنترنت.</div>';
      }
    });

    // SEND fee proof
    feeForm.addEventListener('submit', async (ev)=>{
      ev.preventDefault();
      feeMsg.innerHTML = '';
      const errs = validateFee();
      if(errs.length){ feeMsg.innerHTML = '<div style="color:#b91c1c"><strong>يرجى تصحيح الأخطاء:</strong><ul style="margin:6px 0 0 18px;padding:0">'+errs.map(x=>'<li>'+x+'</li>').join('')+'</ul></div>'; feeForm.scrollIntoView({behavior:'smooth'}); return; }

      const fd = new FormData(feeForm);
      fd.append('_meta_feeId', 'FEE-'+Math.random().toString(36).slice(2,10).toUpperCase());
      fd.append('_meta_timestamp', new Date().toISOString());
      fd.append('feeIban', IBAN);
      fd.append('notifyEmail', NOTIFY_EMAIL);

      feeMsg.innerHTML = '<div class="small">جاري إرسال إثبات الدفع... الرجاء الانتظار.</div>';

      try {
        const res = await fetch(FORMCARRY_URL, { method:'POST', body: fd });
        if(!res.ok) throw new Error('HTTP '+res.status);
        feeMsg.innerHTML = '<div style="color:#065f46"><strong>تم إرسال إثبات الدفع بنجاح.</strong> شكراً لك، سنراجع الإيصال ونتواصل معك.</div>';
        setTimeout(()=> { feeForm.reset(); }, 900);
      } catch(err){
        console.error(err);
        feeMsg.innerHTML = '<div style="color:#b91c1c">فشل الإرسال. تحقق من إعدادات الـ Apps Script أو من اتصال الإنترنت.</div>';
      }
    });

    // Close on ESC
    document.addEventListener('keydown', (ev)=> { if(ev.key === 'Escape' && drawer.classList.contains('open')) closeDrawer(); });

    // start closed
    closeDrawer();

  }); // ready
})(); // IIFE
</script>

</body>
</html>
